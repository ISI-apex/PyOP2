<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>PyOP2 Concepts &mdash; PyOP2 0.10.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.10.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="PyOP2 0.10.0 documentation" href="index.html" />
    <link rel="next" title="PyOP2 Kernels" href="kernels.html" />
    <link rel="prev" title="Installing PyOP2" href="installation.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="kernels.html" title="PyOP2 Kernels"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="installation.html" title="Installing PyOP2"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">PyOP2 0.10.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="pyop2-concepts">
<span id="concepts"></span><h1>PyOP2 Concepts<a class="headerlink" href="#pyop2-concepts" title="Permalink to this headline">¶</a></h1>
<p>Many numerical algorithms and scientific computations on unstructured meshes
can be viewed as the <em>independent application</em> of a <em>local operation</em>
everywhere on a mesh. This local operation is often called a computational
<em>kernel</em> and its independent application lends itself naturally to parallel
computation. An unstructured mesh can be described by <em>sets of entities</em>
(vertices, edges, cells) and the connectivity between those sets forming the
topology of the mesh.</p>
<p>PyOP2 is a domain-specific language (DSL) for the parallel executions of
computational kernels on unstructured meshes or graphs.</p>
<div class="section" id="sets-and-mappings">
<span id="sets"></span><h2>Sets and mappings<a class="headerlink" href="#sets-and-mappings" title="Permalink to this headline">¶</a></h2>
<p>A mesh is defined by <a class="reference internal" href="user.html#pyop2.Set" title="pyop2.Set"><tt class="xref py py-class docutils literal"><span class="pre">sets</span></tt></a> of entities and
<a class="reference internal" href="user.html#pyop2.Map" title="pyop2.Map"><tt class="xref py py-class docutils literal"><span class="pre">mappings</span></tt></a> between these sets. Sets are used to represent
entities in the mesh (nodes in the graph) or degrees of freedom of data
(fields) living &#8220;on&#8221; the mesh (graph), while maps define the connectivity
between entities (links in the graph) or degrees of freedom, for example
associating an edge with its incident vertices. Sets of mesh entities may
coincide with sets of degrees of freedom, but this is not necessarily the case
e.g. the set of degrees of freedom for a field may be defined on the vertices
of the mesh and the midpoints of edges connecting the vertices.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is a requirement for the map to be of <em>constant arity</em>, that is each
element in the source set must be associated with a constant number of
elements in the target set. There is no requirement for the map to be
injective or surjective. This restriction excludes certain kinds of mappings
e.g. a map from vertices to incident egdes or cells is only possible on a
very regular mesh where the multiplicity of any vertex is constant.</p>
</div>
<p>In the following we declare a <a class="reference internal" href="user.html#pyop2.Set" title="pyop2.Set"><tt class="xref py py-class docutils literal"><span class="pre">Set</span></tt></a> <tt class="docutils literal"><span class="pre">vertices</span></tt>, a
<a class="reference internal" href="user.html#pyop2.Set" title="pyop2.Set"><tt class="xref py py-class docutils literal"><span class="pre">Set</span></tt></a> <tt class="docutils literal"><span class="pre">edges</span></tt> and a <a class="reference internal" href="user.html#pyop2.Map" title="pyop2.Map"><tt class="xref py py-class docutils literal"><span class="pre">Map</span></tt></a> <tt class="docutils literal"><span class="pre">edges2vertices</span></tt>
between them, which associates the two incident vertices with each edge:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">vertices</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">edges</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">edges2vertices</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="section" id="data">
<span id="id1"></span><h2>Data<a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h2>
<p>PyOP2 distinguishes three kinds of user provided data: data that lives on a
set (often referred to as a field) is represented by a <a class="reference internal" href="user.html#pyop2.Dat" title="pyop2.Dat"><tt class="xref py py-class docutils literal"><span class="pre">Dat</span></tt></a>,
data that has no association with a set by a <a class="reference internal" href="user.html#pyop2.Global" title="pyop2.Global"><tt class="xref py py-class docutils literal"><span class="pre">Global</span></tt></a> and data
that is visible globally and referred to by a unique identifier is declared as
<a class="reference internal" href="user.html#pyop2.Const" title="pyop2.Const"><tt class="xref py py-class docutils literal"><span class="pre">Const</span></tt></a>. Examples of the use of these data types are given in
the <a class="reference internal" href="#par-loops"><em>Parallel loops</em></a> section below.</p>
<div class="section" id="dat">
<span id="data-dat"></span><h3>Dat<a class="headerlink" href="#dat" title="Permalink to this headline">¶</a></h3>
<p>Since a set does not have any type but only a cardinality, data declared on a
set through a <a class="reference internal" href="user.html#pyop2.Dat" title="pyop2.Dat"><tt class="xref py py-class docutils literal"><span class="pre">Dat</span></tt></a> needs additional metadata to allow PyOP2 to
inpret the data and to specify how much memory is required to store it. This
metadata is the <em>datatype</em> and the <em>shape</em> of the data associated with any
given set element. The shape is not associated with the <a class="reference internal" href="user.html#pyop2.Dat" title="pyop2.Dat"><tt class="xref py py-class docutils literal"><span class="pre">Dat</span></tt></a>
directly, but with a <a class="reference internal" href="user.html#pyop2.DataSet" title="pyop2.DataSet"><tt class="xref py py-class docutils literal"><span class="pre">DataSet</span></tt></a>. One can associate a scalar with
each element of the set or a one- or higher-dimensional vector. Similar to the
restriction on maps, the shape and therefore the size of the data associated
which each element needs to be uniform. PyOP2 supports all common primitive
data types supported by <a class="reference external" href="http://docs.scipy.org/doc/numpy/reference/arrays.dtypes.html">NumPy</a>.  Custom datatypes are supported insofar as
the user implements the serialisation and deserialisation of that type into
primitive data that can be handled by PyOP2.</p>
<p>Declaring coordinate data on the <tt class="docutils literal"><span class="pre">vertices</span></tt> defined above, where two float
coordinates are associated with each vertex, is done like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">dvertices</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">DataSet</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">Dat</span><span class="p">(</span><span class="n">dvertices</span><span class="p">,</span>
                      <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]],</span>
                      <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="global">
<span id="data-global"></span><h3>Global<a class="headerlink" href="#global" title="Permalink to this headline">¶</a></h3>
<p>In contrast to a <a class="reference internal" href="user.html#pyop2.Dat" title="pyop2.Dat"><tt class="xref py py-class docutils literal"><span class="pre">Dat</span></tt></a>, a <a class="reference internal" href="user.html#pyop2.Global" title="pyop2.Global"><tt class="xref py py-class docutils literal"><span class="pre">Global</span></tt></a> has no
association to a set and the shape and type of the data are declared directly
on the <a class="reference internal" href="user.html#pyop2.Global" title="pyop2.Global"><tt class="xref py py-class docutils literal"><span class="pre">Global</span></tt></a>. A 2x2 elasticity tensor would be defined as
follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">elasticity</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">Global</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">[[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="const">
<span id="data-const"></span><h3>Const<a class="headerlink" href="#const" title="Permalink to this headline">¶</a></h3>
<p>Data that is globally visible and read-only to kernels is declared with a
<a class="reference internal" href="user.html#pyop2.Const" title="pyop2.Const"><tt class="xref py py-class docutils literal"><span class="pre">Const</span></tt></a> and needs to have a globally unique identifier.  It does
not need to be declared as an argument to a <a class="reference internal" href="user.html#pyop2.par_loop" title="pyop2.par_loop"><tt class="xref py py-func docutils literal"><span class="pre">par_loop()</span></tt></a>, but is
accessible in a kernel by name. A globally visible parameter <tt class="docutils literal"><span class="pre">eps</span></tt> would be
declared as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">eps</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">Const</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1e-14</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;eps&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="mat">
<span id="data-mat"></span><h3>Mat<a class="headerlink" href="#mat" title="Permalink to this headline">¶</a></h3>
<p>In a PyOP2 context, a (sparse) matrix is a linear operator from one set to
another. In other words, it is a linear function which takes a
<a class="reference internal" href="user.html#pyop2.Dat" title="pyop2.Dat"><tt class="xref py py-class docutils literal"><span class="pre">Dat</span></tt></a> on one set <img class="math" src="_images/math/019e9892786e493964e145e7c5cf7b700314e53b.png" alt="A"/> and returns the value of a
<a class="reference internal" href="user.html#pyop2.Dat" title="pyop2.Dat"><tt class="xref py py-class docutils literal"><span class="pre">Dat</span></tt></a> on another set <img class="math" src="_images/math/ff5fb3d775862e2123b007eb4373ff6cc1a34d4e.png" alt="B"/>. Of course, in particular,
<img class="math" src="_images/math/019e9892786e493964e145e7c5cf7b700314e53b.png" alt="A"/> may be the same set as <img class="math" src="_images/math/ff5fb3d775862e2123b007eb4373ff6cc1a34d4e.png" alt="B"/>. This makes the operation of at
least some matrices equivalent to the operation of a particular PyOP2 kernel.</p>
<p>PyOP2 can be used to assemble <a class="reference internal" href="user.html#pyop2.Mat" title="pyop2.Mat"><tt class="xref py py-class docutils literal"><span class="pre">matrices</span></tt></a>, which are defined
on a <a class="reference internal" href="user.html#pyop2.Sparsity" title="pyop2.Sparsity"><tt class="xref py py-class docutils literal"><span class="pre">sparsity</span> <span class="pre">pattern</span></tt></a> which is built from a pair of
<a class="reference internal" href="user.html#pyop2.DataSet" title="pyop2.DataSet"><tt class="xref py py-class docutils literal"><span class="pre">DataSets</span></tt></a> defining the row and column spaces the
sparsity maps between and one or more pairs of maps, one for the row and one
for the column space of the matrix respectively. The sparsity uniquely defines
the non-zero structure of the sparse matrix and can be constructed purely from
those mappings. To declare a <a class="reference internal" href="user.html#pyop2.Mat" title="pyop2.Mat"><tt class="xref py py-class docutils literal"><span class="pre">Mat</span></tt></a> on a <a class="reference internal" href="user.html#pyop2.Sparsity" title="pyop2.Sparsity"><tt class="xref py py-class docutils literal"><span class="pre">Sparsity</span></tt></a>
only the data type needs to be given.</p>
<p>Since the construction of large sparsity patterns is a very expensive
operation, the decoupling of <a class="reference internal" href="user.html#pyop2.Mat" title="pyop2.Mat"><tt class="xref py py-class docutils literal"><span class="pre">Mat</span></tt></a> and <a class="reference internal" href="user.html#pyop2.Sparsity" title="pyop2.Sparsity"><tt class="xref py py-class docutils literal"><span class="pre">Sparsity</span></tt></a>
allows the reuse of sparsity patterns for a number of matrices without
recomputation. In fact PyOP2 takes care of caching sparsity patterns on behalf
of the user, so declaring a sparsity on the same maps as a previously declared
sparsity yields the cached object instead of building another one.</p>
<p>Defining a matrix of floats on a sparsity which spans from the space of
vertices to the space of vertices via the edges is done as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sparsity</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">Sparsity</span><span class="p">((</span><span class="n">dvertices</span><span class="p">,</span> <span class="n">dvertices</span><span class="p">),</span>
                        <span class="p">[(</span><span class="n">edges2vertices</span><span class="p">,</span> <span class="n">edges2vertices</span><span class="p">)])</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">Mat</span><span class="p">(</span><span class="n">sparsity</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="parallel-loops">
<span id="par-loops"></span><h2>Parallel loops<a class="headerlink" href="#parallel-loops" title="Permalink to this headline">¶</a></h2>
<p>Computations in PyOP2 are executed as <a class="reference internal" href="user.html#pyop2.par_loop" title="pyop2.par_loop"><tt class="xref py py-func docutils literal"><span class="pre">parallel</span> <span class="pre">loops</span></tt></a>
of a <a class="reference internal" href="user.html#pyop2.Kernel" title="pyop2.Kernel"><tt class="xref py py-class docutils literal"><span class="pre">Kernel</span></tt></a> over an <em>iteration set</em>. Parallel loops are the
core construct of PyOP2 and hide most of its complexity such as parallel
scheduling, partitioning, colouring, data transfer from and to device and
staging of the data into on chip memory. Computations in a parallel loop must
be independent of the order in which they are executed over the set to allow
PyOP2 maximum flexibility to schedule the computation in the most efficient
way. Kernels are described in more detail in <a class="reference internal" href="kernels.html"><em>PyOP2 Kernels</em></a>.</p>
<div class="section" id="loop-invocations">
<span id="id2"></span><h3>Loop invocations<a class="headerlink" href="#loop-invocations" title="Permalink to this headline">¶</a></h3>
<p>A parallel loop invocation requires as arguments, other than the iteration set
and the kernel to operate on, the data the kernel reads and/or writes. A
parallel loop argument is constructed by calling the underlying data object
(i.e. the <a class="reference internal" href="user.html#pyop2.Dat" title="pyop2.Dat"><tt class="xref py py-class docutils literal"><span class="pre">Dat</span></tt></a> or <a class="reference internal" href="user.html#pyop2.Global" title="pyop2.Global"><tt class="xref py py-class docutils literal"><span class="pre">Global</span></tt></a>) and passing an
<em>access descriptor</em> and the mapping to be used when accessing the data. The
mapping is required for an <em>indirectly accessed</em> <a class="reference internal" href="user.html#pyop2.Dat" title="pyop2.Dat"><tt class="xref py py-class docutils literal"><span class="pre">Dat</span></tt></a> not
declared on the same set as the iteration set of the parallel loop. In the
case of <em>directly accessed</em> data defined on the same set as the iteration set
the map is omitted and only an access descriptor given.</p>
<p>Consider a parallel loop that translates the <tt class="docutils literal"><span class="pre">coordinate</span></tt> field by a
constant offset given by the <a class="reference internal" href="user.html#pyop2.Const" title="pyop2.Const"><tt class="xref py py-class docutils literal"><span class="pre">Const</span></tt></a> <tt class="docutils literal"><span class="pre">offset</span></tt>. Note how the
kernel has access to the local variable <tt class="docutils literal"><span class="pre">offset</span></tt> even though it has not been
passed as an argument to the <a class="reference internal" href="user.html#pyop2.par_loop" title="pyop2.par_loop"><tt class="xref py py-func docutils literal"><span class="pre">par_loop()</span></tt></a>. This loop is direct and
the argument <tt class="docutils literal"><span class="pre">coordinates</span></tt> is read and written:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">op2</span><span class="o">.</span><span class="n">Const</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;offset&quot;</span><span class="p">);</span>

<span class="n">translate</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">Kernel</span><span class="p">(</span><span class="s">&quot;&quot;&quot;void translate(double * coords) {</span>
<span class="s">  coords[0] += offset[0];</span>
<span class="s">  coords[1] += offset[1];</span>
<span class="s">}&quot;&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;translate&quot;</span><span class="p">)</span>

<span class="n">op2</span><span class="o">.</span><span class="n">par_loop</span><span class="p">(</span><span class="n">translate</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">RW</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="access-descriptors">
<span id="id3"></span><h3>Access descriptors<a class="headerlink" href="#access-descriptors" title="Permalink to this headline">¶</a></h3>
<p>Access descriptors define how the data is accessed by the kernel and give
PyOP2 crucial information as to how the data needs to be treated during
staging in before and staging out after kernel execution. They must be one of
<a class="reference internal" href="user.html#pyop2.READ" title="pyop2.READ"><tt class="xref py py-data docutils literal"><span class="pre">pyop2.READ</span></tt></a> (read-only), <a class="reference internal" href="user.html#pyop2.WRITE" title="pyop2.WRITE"><tt class="xref py py-data docutils literal"><span class="pre">pyop2.WRITE</span></tt></a> (write-only),
<a class="reference internal" href="user.html#pyop2.RW" title="pyop2.RW"><tt class="xref py py-data docutils literal"><span class="pre">pyop2.RW</span></tt></a> (read-write), <a class="reference internal" href="user.html#pyop2.INC" title="pyop2.INC"><tt class="xref py py-data docutils literal"><span class="pre">pyop2.INC</span></tt></a> (increment),
<a class="reference internal" href="user.html#pyop2.MIN" title="pyop2.MIN"><tt class="xref py py-data docutils literal"><span class="pre">pyop2.MIN</span></tt></a> (minimum reduction) or <a class="reference internal" href="user.html#pyop2.MAX" title="pyop2.MAX"><tt class="xref py py-data docutils literal"><span class="pre">pyop2.MAX</span></tt></a> (maximum
reduction).</p>
<p>Not all of these descriptors apply to all PyOP2 data types. A
<a class="reference internal" href="user.html#pyop2.Dat" title="pyop2.Dat"><tt class="xref py py-class docutils literal"><span class="pre">Dat</span></tt></a> can have modes <a class="reference internal" href="user.html#pyop2.READ" title="pyop2.READ"><tt class="xref py py-data docutils literal"><span class="pre">READ</span></tt></a>, <a class="reference internal" href="user.html#pyop2.WRITE" title="pyop2.WRITE"><tt class="xref py py-data docutils literal"><span class="pre">WRITE</span></tt></a>,
<a class="reference internal" href="user.html#pyop2.RW" title="pyop2.RW"><tt class="xref py py-data docutils literal"><span class="pre">RW</span></tt></a> and <a class="reference internal" href="user.html#pyop2.INC" title="pyop2.INC"><tt class="xref py py-data docutils literal"><span class="pre">INC</span></tt></a>. For a <a class="reference internal" href="user.html#pyop2.Global" title="pyop2.Global"><tt class="xref py py-class docutils literal"><span class="pre">Global</span></tt></a> the
valid modes are <a class="reference internal" href="user.html#pyop2.READ" title="pyop2.READ"><tt class="xref py py-data docutils literal"><span class="pre">READ</span></tt></a>, <a class="reference internal" href="user.html#pyop2.INC" title="pyop2.INC"><tt class="xref py py-data docutils literal"><span class="pre">INC</span></tt></a>, <a class="reference internal" href="user.html#pyop2.MIN" title="pyop2.MIN"><tt class="xref py py-data docutils literal"><span class="pre">MIN</span></tt></a> and
<a class="reference internal" href="user.html#pyop2.MAX" title="pyop2.MAX"><tt class="xref py py-data docutils literal"><span class="pre">MAX</span></tt></a> and for a <a class="reference internal" href="user.html#pyop2.Mat" title="pyop2.Mat"><tt class="xref py py-class docutils literal"><span class="pre">Mat</span></tt></a> only <a class="reference internal" href="user.html#pyop2.WRITE" title="pyop2.WRITE"><tt class="xref py py-data docutils literal"><span class="pre">WRITE</span></tt></a> and
<a class="reference internal" href="user.html#pyop2.INC" title="pyop2.INC"><tt class="xref py py-data docutils literal"><span class="pre">INC</span></tt></a> are allowed.</p>
</div>
<div class="section" id="loops-assembling-matrices">
<span id="matrix-loops"></span><h3>Loops assembling matrices<a class="headerlink" href="#loops-assembling-matrices" title="Permalink to this headline">¶</a></h3>
<p>We declare a parallel loop assembling the <tt class="docutils literal"><span class="pre">matrix</span></tt> via a given <tt class="docutils literal"><span class="pre">kernel</span></tt>
which we&#8217;ll assume has been defined before over the <tt class="docutils literal"><span class="pre">edges</span></tt> and with
<tt class="docutils literal"><span class="pre">coordinates</span></tt> as input data. The <tt class="docutils literal"><span class="pre">matrix</span></tt> is the output argument of this
parallel loop and therefore has the access descriptor <a class="reference internal" href="user.html#pyop2.INC" title="pyop2.INC"><tt class="xref py py-data docutils literal"><span class="pre">INC</span></tt></a> since
the assembly accumulates contributions from different vertices via the
<tt class="docutils literal"><span class="pre">edges2vertices</span></tt> mapping. Note that the mappings are being indexed with the
<a class="reference internal" href="pyop2.html#pyop2.base.IterationIndex" title="pyop2.base.IterationIndex"><tt class="xref py py-class docutils literal"><span class="pre">iteration</span> <span class="pre">indices</span></tt></a> <tt class="docutils literal"><span class="pre">op2.i[0]</span></tt> and
<tt class="docutils literal"><span class="pre">op2.i[1]</span></tt> respectively. This means that PyOP2 generates a <a class="reference internal" href="kernels.html#local-iteration-spaces"><em>local
iteration space</em></a> of size <tt class="docutils literal"><span class="pre">arity</span> <span class="pre">*</span> <span class="pre">arity</span></tt> with the
<tt class="docutils literal"><span class="pre">arity</span></tt> of the <a class="reference internal" href="user.html#pyop2.Map" title="pyop2.Map"><tt class="xref py py-class docutils literal"><span class="pre">Map</span></tt></a> <tt class="docutils literal"><span class="pre">edges2vertices</span></tt> for any given element
of the iteration set.  This local iteration space is then iterated over using
the iteration indices on the maps.  The kernel is assumed to only apply to a
single point in that local iteration space. The <tt class="docutils literal"><span class="pre">coordinates</span></tt> are accessed
via the same mapping, but are a read-only input argument to the kernel and
therefore use the access descriptor <a class="reference internal" href="user.html#pyop2.READ" title="pyop2.READ"><tt class="xref py py-data docutils literal"><span class="pre">READ</span></tt></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">op2</span><span class="o">.</span><span class="n">par_loop</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">edges</span><span class="p">,</span>
             <span class="n">matrix</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">INC</span><span class="p">,</span> <span class="p">(</span><span class="n">edges2vertices</span><span class="p">[</span><span class="n">op2</span><span class="o">.</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                              <span class="n">edges2vertices</span><span class="p">[</span><span class="n">op2</span><span class="o">.</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]])),</span>
             <span class="n">coordinates</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">READ</span><span class="p">,</span> <span class="n">edges2vertices</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="loops-with-global-reductions">
<span id="reduction-loops"></span><h3>Loops with global reductions<a class="headerlink" href="#loops-with-global-reductions" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="user.html#pyop2.Global" title="pyop2.Global"><tt class="xref py py-class docutils literal"><span class="pre">Globals</span></tt></a> are used primarily for reductions where a
given quantity on a field is reduced to a single number by summation or
finding the minimum or maximum. Consider a kernel computing the <a class="reference external" href="https://en.wikipedia.org/wiki/L2_norm#Euclidean_norm">L2 norm</a> of
the <tt class="docutils literal"><span class="pre">pressure</span></tt> field defined on the set of <tt class="docutils literal"><span class="pre">vertices</span></tt> as <tt class="docutils literal"><span class="pre">l2norm</span></tt>. Note
that the <a class="reference internal" href="user.html#pyop2.Dat" title="pyop2.Dat"><tt class="xref py py-class docutils literal"><span class="pre">Dat</span></tt></a> constructor automatically creates an anonymous
<a class="reference internal" href="user.html#pyop2.DataSet" title="pyop2.DataSet"><tt class="xref py py-class docutils literal"><span class="pre">DataSet</span></tt></a> of dimension 1 if a <a class="reference internal" href="user.html#pyop2.Set" title="pyop2.Set"><tt class="xref py py-class docutils literal"><span class="pre">Set</span></tt></a> is passed as
the first argument. We assume <tt class="docutils literal"><span class="pre">pressure</span></tt> is the result of some prior
computation and only give the declaration for context.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">pressure</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">Dat</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="p">[</span><span class="o">...</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="n">l2norm</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">Global</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">])</span>

<span class="n">norm</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">Kernel</span><span class="p">(</span><span class="s">&quot;&quot;&quot;void norm(double * out, double * field) {</span>
<span class="s">  *out += field[0] * field[0];</span>
<span class="s">}&quot;&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;norm&quot;</span><span class="p">)</span>

<span class="n">op2</span><span class="o">.</span><span class="n">par_loop</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span>
             <span class="n">l2norm</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">INC</span><span class="p">),</span>
             <span class="n">vertices</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">READ</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">PyOP2 Concepts</a><ul>
<li><a class="reference internal" href="#sets-and-mappings">Sets and mappings</a></li>
<li><a class="reference internal" href="#data">Data</a><ul>
<li><a class="reference internal" href="#dat">Dat</a></li>
<li><a class="reference internal" href="#global">Global</a></li>
<li><a class="reference internal" href="#const">Const</a></li>
<li><a class="reference internal" href="#mat">Mat</a></li>
</ul>
</li>
<li><a class="reference internal" href="#parallel-loops">Parallel loops</a><ul>
<li><a class="reference internal" href="#loop-invocations">Loop invocations</a></li>
<li><a class="reference internal" href="#access-descriptors">Access descriptors</a></li>
<li><a class="reference internal" href="#loops-assembling-matrices">Loops assembling matrices</a></li>
<li><a class="reference internal" href="#loops-with-global-reductions">Loops with global reductions</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="installation.html"
                        title="previous chapter">Installing PyOP2</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="kernels.html"
                        title="next chapter">PyOP2 Kernels</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/concepts.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="kernels.html" title="PyOP2 Kernels"
             >next</a> |</li>
        <li class="right" >
          <a href="installation.html" title="Installing PyOP2"
             >previous</a> |</li>
        <li><a href="index.html">PyOP2 0.10.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012-2013, Imperial College et al.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>