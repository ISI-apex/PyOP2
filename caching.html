<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Caching in PyOP2 &mdash; PyOP2 0.11.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.11.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="PyOP2 0.11.0 documentation" href="index.html" />
    <link rel="next" title="Profiling" href="profiling.html" />
    <link rel="prev" title="MPI" href="mpi.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="profiling.html" title="Profiling"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="mpi.html" title="MPI"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">PyOP2 0.11.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="caching-in-pyop2">
<span id="caching"></span><h1>Caching in PyOP2<a class="headerlink" href="#caching-in-pyop2" title="Permalink to this headline">¶</a></h1>
<p>PyOP2 makes heavy use of caches to ensure performance is not adversely
affected by too many runtime computations.  The caching in PyOP2 takes
a number of forms:</p>
<ol class="arabic">
<li><p class="first">Disk-based caching of generated code</p>
<p>Since compiling a generated code module may be an expensive
operation, PyOP2 caches the generated code on disk such that
subsequent runs of the same simulation will not have to pay a
compilation cost.</p>
</li>
<li><p class="first">In memory caching of generated code function pointers</p>
<p>Once code has been generated and loaded into the running PyOP2
process, we cache the resulting callable function pointer for the
lifetime of the process, such that subsequent calls to the same
generated code are fast.</p>
</li>
<li><p class="first">In memory caching of expensive to build objects</p>
<p>Some PyOP2 objects, in particular <a class="reference internal" href="user.html#pyop2.Sparsity" title="pyop2.Sparsity"><tt class="xref py py-class docutils literal"><span class="pre">Sparsity</span></tt></a> objects,
can be expensive to construct.  Since a sparsity does not change if
it is built again with the same arguments, we only construct the
sparsity once for each unique set of arguments.</p>
</li>
</ol>
<p>The caching strategies for PyOP2 follow from two axioms:</p>
<ol class="arabic simple">
<li>For PyOP2 <a class="reference internal" href="user.html#pyop2.Set" title="pyop2.Set"><tt class="xref py py-class docutils literal"><span class="pre">Set</span></tt></a>s and <a class="reference internal" href="user.html#pyop2.Map" title="pyop2.Map"><tt class="xref py py-class docutils literal"><span class="pre">Map</span></tt></a>s, equality
is identity</li>
<li>Caches of generated code should depend on metadata, but not data</li>
</ol>
<p>The first axiom implies that two <a class="reference internal" href="user.html#pyop2.Set" title="pyop2.Set"><tt class="xref py py-class docutils literal"><span class="pre">Set</span></tt></a>s or
<a class="reference internal" href="user.html#pyop2.Map" title="pyop2.Map"><tt class="xref py py-class docutils literal"><span class="pre">Map</span></tt></a>s compare equal if and only if they are the same
object.  The second implies that generated code must be <em>independent</em>
of the absolute size of the data the <a class="reference internal" href="user.html#pyop2.par_loop" title="pyop2.par_loop"><tt class="xref py py-func docutils literal"><span class="pre">par_loop()</span></tt></a> that
generated it executed over.  For example, the size of the iteration
set should not be part of the key, but the arity of any maps and size
and type of every data item should be.</p>
<p>On consequence of these rules is that there are effectively two
separate types of cache in PyOP2, object and class caches,
distinguished by where the cache itself lives.</p>
<div class="section" id="class-caches">
<h2>Class caches<a class="headerlink" href="#class-caches" title="Permalink to this headline">¶</a></h2>
<p>These are used to cache objects that depend on metadata, but not
object instances, such are generated code.  They are implemented by
the cacheable class inheriting from <a class="reference internal" href="pyop2.html#pyop2.caching.Cached" title="pyop2.caching.Cached"><tt class="xref py py-class docutils literal"><span class="pre">Cached</span></tt></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is currently no eviction strategy for class caches, should
they grow too large, for example by executing many different parallel
loops, an out of memory error can occur</p>
</div>
</div>
<div class="section" id="object-caches">
<h2>Object caches<a class="headerlink" href="#object-caches" title="Permalink to this headline">¶</a></h2>
<p>These are used to cache objects that are built on top of
<a class="reference internal" href="user.html#pyop2.Set" title="pyop2.Set"><tt class="xref py py-class docutils literal"><span class="pre">Set</span></tt></a>s and <a class="reference internal" href="user.html#pyop2.Map" title="pyop2.Map"><tt class="xref py py-class docutils literal"><span class="pre">Map</span></tt></a>s.  They are implemented by the
cacheable class inheriting from <a class="reference internal" href="pyop2.html#pyop2.caching.ObjectCached" title="pyop2.caching.ObjectCached"><tt class="xref py py-class docutils literal"><span class="pre">ObjectCached</span></tt></a> and the
caching instance defining a <tt class="docutils literal"><span class="pre">_cache</span></tt> attribute.</p>
<p>The motivation for these caches is that cache key for objects such as
sparsities relies on an identical sparsity being built if the
arguments are identical.  So that users of the API do not have to
worry too much about carrying around &#8220;temporary&#8221; objects forever such
that they will hit caches, PyOP2 builds up a hierarchy of caches of
transient objects on top of the immutable sets and maps.</p>
<p>So, for example, the user can build and throw away
<a class="reference internal" href="user.html#pyop2.DataSet" title="pyop2.DataSet"><tt class="xref py py-class docutils literal"><span class="pre">DataSet</span></tt></a>s as normal in their code.  Internally, however,
these instances are cached on the set they are built on top of.  Thus,
in the following snippet, we have that <tt class="docutils literal"><span class="pre">ds</span></tt> and <tt class="docutils literal"><span class="pre">ds2</span></tt> are the same
object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">s</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">DataSet</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">ds2</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">DataSet</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">ds</span> <span class="ow">is</span> <span class="n">ds2</span>
</pre></div>
</div>
<p>The setup of these caches is such that the lifetime of objects in the
cache is tied to the lifetime of both the caching and the cached
object.  In the above example, as long as the user program holds a
reference to one of <tt class="docutils literal"><span class="pre">s</span></tt>, <tt class="docutils literal"><span class="pre">ds</span></tt> or <tt class="docutils literal"><span class="pre">ds2</span></tt> all three objects will
remain live.  As soon as all references are lost, all three become
candidates for garbage collection.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The cache eviction strategy for these caches relies on the Python
garbage collector, and hence on the user not holding onto
references to some of either the cached or the caching objects for
too long.  Should the objects on which the caches live persist, an
out of memory error may occur.</p>
</div>
</div>
<div class="section" id="debugging-cache-leaks">
<h2>Debugging cache leaks<a class="headerlink" href="#debugging-cache-leaks" title="Permalink to this headline">¶</a></h2>
<p>To debug potential problems with the cache, PyOP2 can be instructed to
print the size of both object and class caches at program exit.  This
can be done by setting the environment variable
<tt class="docutils literal"><span class="pre">PYOP2_PRINT_CACHE_SIZE</span></tt> to 1 before running a PyOP2 program, or
passing the <tt class="docutils literal"><span class="pre">print_cache_size</span></tt> to <a class="reference internal" href="user.html#pyop2.init" title="pyop2.init"><tt class="xref py py-func docutils literal"><span class="pre">init()</span></tt></a>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Caching in PyOP2</a><ul>
<li><a class="reference internal" href="#class-caches">Class caches</a></li>
<li><a class="reference internal" href="#object-caches">Object caches</a></li>
<li><a class="reference internal" href="#debugging-cache-leaks">Debugging cache leaks</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="mpi.html"
                        title="previous chapter">MPI</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="profiling.html"
                        title="next chapter">Profiling</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/caching.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="profiling.html" title="Profiling"
             >next</a> |</li>
        <li class="right" >
          <a href="mpi.html" title="MPI"
             >previous</a> |</li>
        <li><a href="index.html">PyOP2 0.11.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2012-2013, Imperial College et al.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3a0.
    </div>
  </body>
</html>