<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Parallel Execution Plan &mdash; PyOP2 0.11.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.11.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="PyOP2 0.11.0 documentation" href="index.html" />
    <link rel="next" title="Mixed Types" href="mixed.html" />
    <link rel="prev" title="PyOP2 Linear Algebra Interface" href="linear_algebra.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="mixed.html" title="Mixed Types"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="linear_algebra.html" title="PyOP2 Linear Algebra Interface"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">PyOP2 0.11.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="parallel-execution-plan">
<span id="plan"></span><h1>Parallel Execution Plan<a class="headerlink" href="#parallel-execution-plan" title="Permalink to this headline">¶</a></h1>
<p>For all PyOP2 backends with the exception of sequential, a parallel execution
plan is computed for each <a class="reference internal" href="user.html#pyop2.par_loop" title="pyop2.par_loop"><tt class="xref py py-func docutils literal"><span class="pre">par_loop()</span></tt></a>. It contains information
guiding the code generator on how to partition, stage and colour the data for
efficient parallel processing.</p>
<div class="section" id="partitioning">
<span id="plan-partitioning"></span><h2>Partitioning<a class="headerlink" href="#partitioning" title="Permalink to this headline">¶</a></h2>
<p>The iteration set is split into a number of equally sized and contiguous
mini-partitions such that the working set of each mini-partition fits into
shared memory or last level cache. This is unrelated to the partitioning
required for MPI as described in <a class="reference internal" href="mpi.html#mpi"><em>MPI</em></a>.</p>
</div>
<div class="section" id="local-renumbering-and-staging">
<span id="plan-renumbering"></span><h2>Local Renumbering and Staging<a class="headerlink" href="#local-renumbering-and-staging" title="Permalink to this headline">¶</a></h2>
<p>While a mini-partition is a contiguous chunk of the iteration set, the
indirectly accessed data it references is not necessarily contiguous. For each
mini-partition and unique <a class="reference internal" href="user.html#pyop2.Dat" title="pyop2.Dat"><tt class="xref py py-class docutils literal"><span class="pre">Dat</span></tt></a>-<a class="reference internal" href="user.html#pyop2.Map" title="pyop2.Map"><tt class="xref py py-class docutils literal"><span class="pre">Map</span></tt></a> pair, a
mapping from local indices within the partition to global indices is
constructed as the sorted array of unique <a class="reference internal" href="user.html#pyop2.Map" title="pyop2.Map"><tt class="xref py py-class docutils literal"><span class="pre">Map</span></tt></a> indices accessed
by this partition. At the same time, a global-to-local mapping is constructed
as its inverse.</p>
<p>Data for indirectly accessed <a class="reference internal" href="user.html#pyop2.Dat" title="pyop2.Dat"><tt class="xref py py-class docutils literal"><span class="pre">Dat</span></tt></a> arguments is staged in shared
device memory as described in <a class="reference internal" href="backends.html#backends"><em>PyOP2 Backends</em></a>. For each partition, the
local-to-global mapping indicates where data to be staged in is read from and
the global-to-local mapping gives the location in shared memory data has been
staged at. The amount of shared memory required is computed from the size of
the local-to-global mapping.</p>
</div>
<div class="section" id="colouring">
<span id="plan-colouring"></span><h2>Colouring<a class="headerlink" href="#colouring" title="Permalink to this headline">¶</a></h2>
<p>A two-level colouring is used to avoid race conditions. Partitions are
coloured such that partitions of the same colour can be executed concurrently
and threads executing on a partition in parallel are coloured such that no two
threads indirectly reference the same data. Only <a class="reference internal" href="user.html#pyop2.par_loop" title="pyop2.par_loop"><tt class="xref py py-func docutils literal"><span class="pre">par_loop()</span></tt></a>
arguments performing an indirect reduction or assembling a matrix require
colouring. Matrices are coloured per row.</p>
<p>For each element of a <a class="reference internal" href="user.html#pyop2.Set" title="pyop2.Set"><tt class="xref py py-class docutils literal"><span class="pre">Set</span></tt></a> indirectly accessed in a
<a class="reference internal" href="user.html#pyop2.par_loop" title="pyop2.par_loop"><tt class="xref py py-func docutils literal"><span class="pre">par_loop()</span></tt></a>, a bit vector is used to record which colours
indirectly reference it. To colour each thread within a partition, the
algorithm proceeds as follows:</p>
<ol class="arabic simple">
<li>Loop over all indirectly accessed arguments and collect the colours of all
<a class="reference internal" href="user.html#pyop2.Set" title="pyop2.Set"><tt class="xref py py-class docutils literal"><span class="pre">Set</span></tt></a> elements referenced by the current thread in a bit mask.</li>
<li>Choose the next available colour as the colour of the current thread.</li>
<li>Loop over all <a class="reference internal" href="user.html#pyop2.Set" title="pyop2.Set"><tt class="xref py py-class docutils literal"><span class="pre">Set</span></tt></a> elements indirectly accessed by the
current thread again and set the new colour in their colour mask.</li>
</ol>
<p>Since the bit mask is a 32-bit integer, up to 32 colours can be processed in a
single pass, which is sufficient for most applications. If not all threads can
be coloured with 32 distinct colours, the mask is reset and another pass is
made, where each newly allocated colour is offset by 32. Should another pass
be required, the offset is increased to 64 and so on until all threads are
coloured.</p>
<div class="figure align-center">
<img src="_images/pyop2_colouring.svg" /><p class="caption">Thread colouring within a mini-partition for a <a class="reference internal" href="user.html#pyop2.Dat" title="pyop2.Dat"><tt class="xref py py-class docutils literal"><span class="pre">Dat</span></tt></a> on
vertices indirectly accessed in a computation over the edges. The edges are
coloured such that no two edges touch the same vertex within the partition.</p>
</div>
<p>The colouring of mini-partitions is done in the same way, except that all
<a class="reference internal" href="user.html#pyop2.Set" title="pyop2.Set"><tt class="xref py py-class docutils literal"><span class="pre">Set</span></tt></a> elements indirectly accessed by the entire partition are
referenced, not only those accessed by a single thread.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Parallel Execution Plan</a><ul>
<li><a class="reference internal" href="#partitioning">Partitioning</a></li>
<li><a class="reference internal" href="#local-renumbering-and-staging">Local Renumbering and Staging</a></li>
<li><a class="reference internal" href="#colouring">Colouring</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="linear_algebra.html"
                        title="previous chapter">PyOP2 Linear Algebra Interface</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="mixed.html"
                        title="next chapter">Mixed Types</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/plan.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="mixed.html" title="Mixed Types"
             >next</a> |</li>
        <li class="right" >
          <a href="linear_algebra.html" title="PyOP2 Linear Algebra Interface"
             >previous</a> |</li>
        <li><a href="index.html">PyOP2 0.11.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012-2013, Imperial College et al.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>